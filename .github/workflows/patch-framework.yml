name: Patch framework from Release ‚Üí Artifact only (no Release)

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag Release ngu·ªìn ch·ª©a framework.jar (v√≠ d·ª•: v1)'
        required: true
        default: 'v1'

jobs:
  patch-and-artifact:
    runs-on: ubuntu-latest
    permissions:
      contents: read    # ch·ªâ c·∫ßn ƒë·ªçc ƒë·ªÉ t·∫£i release ngu·ªìn
      actions: read     # ƒë·ªçc danh s√°ch artifact c·ªßa run (ƒë·ªÉ in URL)
    env:
      SRC_TAG: ${{ github.event.inputs.tag }}
      REPO: ${{ github.repository }}
      OUT_TAG: pif-${{ github.event.inputs.tag }}-run-${{ github.run_number }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y openjdk-17-jre zip unzip jq curl

      - name: Download framework.jar from source Release
        run: |
          set -e
          mkdir -p framework_patcher
          api_url="https://api.github.com/repos/${REPO}/releases/tags/${SRC_TAG}"
          asset_url=$(curl -s "$api_url" | jq -r '.assets[] | select(.name=="framework.jar") | .browser_download_url')
          if [ -z "$asset_url" ] || [ "$asset_url" = "null" ]; then
            echo "‚ùå Kh√¥ng t√¨m th·∫•y asset framework.jar trong release tag ${SRC_TAG}"
            exit 1
          fi
          echo "‚úÖ Downloading: $asset_url"
          curl -L "$asset_url" -o framework_patcher/framework.jar
          ls -lh framework_patcher/

      - name: Make patch script executable
        run: chmod +x framework_patcher/patchframework.sh

      - name: Run patcher
        working-directory: framework_patcher
        run: |
          set -e
          # Ghi m·ªëc th·ªùi gian ƒë·ªÉ l·ªçc file m·ªõi sinh
          date -u +"%Y-%m-%dT%H:%M:%SZ" > ../_start_time
          ./patchframework.sh
          echo "==== AFTER PATCH ===="
          ls -lah

            - name: Collect outputs (include patched JAR if modified + PIF module)
          run: |
          set -e
          START_TIME=$(cat _start_time)
          mkdir -p outputs

          echo "== List everything after patch for debugging =="
          find framework_patcher -maxdepth 3 -type f -printf "%TY-%Tm-%Td %TH:%TM:%TS %p\n" | sort

          # 1) N·∫øu framework.jar ƒë∆∞·ª£c CH·ªàNH S·ª¨A sau khi ch·∫°y patcher -> l·∫•y
          if find framework_patcher -maxdepth 1 -type f -name "framework.jar" -newermt "$START_TIME" | grep -q . ; then
            echo "‚úÖ Detected patched framework.jar (modified after START_TIME)"
            cp -v framework_patcher/framework.jar outputs/framework_patched.jar
          else
            echo "‚ÑπÔ∏è framework.jar kh√¥ng thay ƒë·ªïi mtime sau khi patch (script c√≥ th·ªÉ build module thay v√¨ thay JAR)"
          fi

          # 2) Gom ZIP module n·∫øu c√≥ (v√≠ d·ª• module s·∫µn s√†ng flash)
          shopt -s nullglob
          mods=(framework_patcher/*.zip *.zip)
          if [ ${#mods[@]} -gt 0 ]; then
            echo "‚úÖ Found module ZIP(s):"
            printf '%s\n' "${mods[@]}"
            cp -v "${mods[@]}" outputs/ || true
          fi

          # 3) Gom th∆∞ m·ª•c PIF (module d·∫°ng th∆∞ m·ª•c) n·∫øu c√≥
          if [ -d framework_patcher/PIF ]; then
            echo "‚úÖ Packing PIF/ module directory"
            (cd framework_patcher && zip -r ../outputs/PIF-module.zip PIF >/dev/null)
          fi

          # 4) Thu th√™m m·ªçi file m·ªõi t·∫°o/s·ª≠a (tr·ª´ script/log) ƒë·ªÉ kh√¥ng b·ªè s√≥t g√¨
          mapfile -t extras < <(find framework_patcher -type f -newermt "$START_TIME" \
                                  ! -name "patchframework.sh" \
                                  ! -name "*.log" 2>/dev/null)
          if [ ${#extras[@]} -gt 0 ]; then
            echo "‚ÑπÔ∏è Extra new/modified files:"
            printf '%s\n' "${extras[@]}"
            cp -vu "${extras[@]}" outputs/ || true
          fi

          echo "== OUTPUTS =="
          ls -lah outputs
          tar -czf outputs-${{ env.OUT_TAG }}.tar.gz -C outputs .


      - name: Upload artifacts (download from this run)
        uses: actions/upload-artifact@v4
        with:
          name: patched-${{ env.OUT_TAG }}
          path: |
            outputs/
            outputs-${{ env.OUT_TAG }}.tar.gz
          if-no-files-found: error
          retention-days: 30

      - name: Print direct Artifact URL
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          run_id=${{ github.run_id }}
          repo=${{ github.repository }}
          # L·∫•y artifact id theo ƒë√∫ng t√™n
          resp=$(curl -s -H "Authorization: Bearer $GH_TOKEN" \
                 "https://api.github.com/repos/$repo/actions/runs/$run_id/artifacts")
          art_id=$(echo "$resp" | jq -r --arg NAME "patched-${OUT_TAG}" '.artifacts[] | select(.name==$NAME) | .id')
          if [ -n "$art_id" ] && [ "$art_id" != "null" ]; then
            echo ""
            echo "================ ARTIFACT DOWNLOAD LINK ================"
            echo "üëâ  https://github.com/$repo/actions/runs/$run_id/artifacts/$art_id"
            echo "========================================================"
            echo ""
          else
            echo "‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y artifact id ƒë·ªÉ in URL. V√†o tab Actions c·ªßa run n√†y ƒë·ªÉ t·∫£i."
          fi

      # (Tu·ª≥ ch·ªçn) Upload to√†n b·ªô th∆∞ m·ª•c ƒë·ªÉ debug
      - name: Upload full patcher folder (debug)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: debug-framework_patcher-${{ env.OUT_TAG }}
          path: framework_patcher/
