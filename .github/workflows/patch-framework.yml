name: PIF Patch (Release asset ‚Üí Patched JAR + NEW immutable Release)

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag Release ngu·ªìn ch·ª©a framework.jar (vd: v1)'
        required: true
        default: 'v1'

jobs:
  patch:
    runs-on: ubuntu-latest
    permissions:
      contents: write   # t·∫°o release m·ªõi & ƒë·ªçc release ngu·ªìn
      actions: read
    env:
      REPO: ${{ github.repository }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies (Java, zip tools, gdown; ensure zipalign)
        run: |
          set -e
          sudo apt-get update
          sudo apt-get install -y openjdk-17-jre zip unzip jq curl p7zip-full python3-pip || true

          # gdown via pip (APT kh√¥ng c√≥ g√≥i gdown)
          python3 -m pip install --upgrade pip
          python3 -m pip install --no-input gdown

          # zipalign: th·ª≠ APT tr∆∞·ªõc, n·∫øu kh√¥ng c√≥ th√¨ t·∫£i build-tools (c√≥ zipalign)
          if ! command -v zipalign >/dev/null 2>&1; then
            echo "zipalign not found via APT, trying to install..."
            sudo apt-get install -y zipalign || true
          fi
          if ! command -v zipalign >/dev/null 2>&1; then
            echo "Downloading Android build-tools (contains zipalign)..."
            VER=34.0.0
            mkdir -p $HOME/android-build-tools
            cd $HOME/android-build-tools
            curl -L -o build-tools.zip "https://dl.google.com/android/repository/build-tools_r${VER}-linux.zip"
            unzip -q build-tools.zip
            echo "$HOME/android-build-tools/android-${VER}/" >> $GITHUB_PATH
            echo "$HOME/android-build-tools/android-${VER}" >> $GITHUB_PATH
            echo "PATH=$PATH:$HOME/android-build-tools/android-${VER}" >> $GITHUB_ENV
            cd -
          fi
          echo "zipalign path: $(command -v zipalign || echo 'NOT FOUND')"

      - name: Download framework.jar from source Release
        env:
          SRC_TAG: ${{ github.event.inputs.tag }}
        run: |
          set -e
          mkdir -p framework_patcher
          api_url="https://api.github.com/repos/${REPO}/releases/tags/${SRC_TAG}"
          asset_url=$(curl -s "$api_url" | jq -r '.assets[] | select(.name=="framework.jar") | .browser_download_url')
          if [ -z "$asset_url" ] || [ "$asset_url" = "null" ]; then
            echo "‚ùå Kh√¥ng t√¨m th·∫•y asset framework.jar trong release tag ${SRC_TAG}"
            exit 1
          fi
          echo "‚û°Ô∏è  Downloading: $asset_url"
          curl -L "$asset_url" -o framework_patcher/framework.jar
          ls -lh framework_patcher/

      - name: Make patch script executable
        run: chmod +x framework_patcher/patchframework.sh

      - name: Run patcher (fail fast)
        working-directory: framework_patcher
        run: |
          set -e
          # m·ªëc th·ªùi gian ƒë·ªÉ l·ªçc file m·ªõi
          date -u +"%Y-%m-%dT%H:%M:%SZ" > ../_start_time
          bash -e ./patchframework.sh
          echo "==== AFTER PATCH ===="
          ls -lah

      - name: Rebuild framework_patched.jar (fallback)
        working-directory: framework_patcher
        run: |
          set -e
          # N·∫øu script ch·ªâ t·∫°o classes.dex th√¨ t·ª± ƒë√≥ng g√≥i l·∫°i JAR ƒë√£ patch
          if [ -f classes.dex ] && [ -f framework.jar ]; then
            echo "üîß Rebuilding framework_patched.jar from framework.jar + classes.dex"
            cp -f framework.jar framework_patched.jar
            zip -d framework_patched.jar 'classes*.dex' || true
            zip -j framework_patched.jar classes.dex
            ls -lh framework_patched.jar
          else
            echo "‚ÑπÔ∏è Kh√¥ng c·∫ßn rebuild (script ƒë√£ t·∫°o JAR s·∫µn ho·∫∑c thi·∫øu classes.dex)."
          fi

      - name: Collect outputs (grab patched JAR + modules)
        run: |
          set -e
          START_TIME=$(cat _start_time)
          mkdir -p outputs

          # ∆Øu ti√™n l·∫•y framework.jar sau patch (ho·∫∑c b·∫£n rebuild)
          if [ -f framework_patcher/framework_patched.jar ]; then
            cp -v framework_patcher/framework_patched.jar outputs/framework_patched.jar
          elif [ -f framework_patcher/framework.jar ]; then
            cp -v framework_patcher/framework.jar outputs/framework_patched.jar
          fi

          # Gom module ZIP (n·∫øu c√≥)
          shopt -s nullglob
          mods=(framework_patcher/*.zip *.zip)
          if [ ${#mods[@]} -gt 0 ]; then
            cp -v "${mods[@]}" outputs/ || true
          fi

          # ƒê√≥ng g√≥i th∆∞ m·ª•c PIF n·∫øu c√≥
          if [ -d framework_patcher/PIF ]; then
            (cd framework_patcher && zip -r ../outputs/PIF-module.zip PIF >/dev/null)
          fi

          # Thu th√™m file m·ªõi/s·ª≠a (tr·ª´ script/log) ƒë·ªÉ kh√¥ng b·ªè s√≥t
          mapfile -t extras < <(find framework_patcher -type f -newermt "$START_TIME" \
                                  ! -name "patchframework.sh" \
                                  ! -name "*.log" 2>/dev/null)
          if [ ${#extras[@]} -gt 0 ]; then
            cp -vu "${extras[@]}" outputs/ || true
          fi

          echo "== OUTPUTS =="
          ls -lah outputs

      - name: Package (tar.gz)
        id: pkg
        run: |
          set -e
          TS=$(date -u +%Y%m%d-%H%M%S)
          OUT_TAG="pif-${{ github.event.inputs.tag }}-${TS}-r${{ github.run_id }}"
          echo "tag=$OUT_TAG"  >> $GITHUB_OUTPUT
          echo "name=Patched $OUT_TAG" >> $GITHUB_OUTPUT
          tar -czf outputs-${OUT_TAG}.tar.gz -C outputs .
          echo "tar=outputs-${OUT_TAG}.tar.gz" >> $GITHUB_OUTPUT

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: patched-${{ steps.pkg.outputs.tag }}
          path: |
            outputs/
            ${{ steps.pkg.outputs.tar }}
          retention-days: 30
          if-no-files-found: error

      # T·∫°o RELEASE m·ªõi v·ªõi tag duy nh·∫•t (t∆∞∆°ng th√≠ch Immutable Releases)
      - name: Create immutable Release (unique tag per run)
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name:  ${{ steps.pkg.outputs.tag }}
          name:      ${{ steps.pkg.outputs.name }}
          body: |
            Auto-patched from workflow run ${{ github.run_id }}.
            Tag is unique to comply with immutable releases.
          draft: false
          prerelease: false
          files: |
            outputs/*
            ${{ steps.pkg.outputs.tar }}
