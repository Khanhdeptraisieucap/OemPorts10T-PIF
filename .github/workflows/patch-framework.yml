name: Patch framework from Release ‚Üí Artifact only (no Release)

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag Release ngu·ªìn ch·ª©a framework.jar (v√≠ d·ª•: v1)'
        required: true
        default: 'v1'

jobs:
  patch-and-artifact:
    runs-on: ubuntu-latest
    permissions:
      contents: read    # ch·ªâ c·∫ßn ƒë·ªçc ƒë·ªÉ t·∫£i release ngu·ªìn
      actions: read     # ƒë·ªçc danh s√°ch artifact c·ªßa run (ƒë·ªÉ in URL)
    env:
      SRC_TAG: ${{ github.event.inputs.tag }}
      REPO: ${{ github.repository }}
      OUT_TAG: pif-${{ github.event.inputs.tag }}-run-${{ github.run_number }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y openjdk-17-jre zip unzip jq curl

      - name: Download framework.jar from source Release
        run: |
          set -e
          mkdir -p framework_patcher
          api_url="https://api.github.com/repos/${REPO}/releases/tags/${SRC_TAG}"
          asset_url=$(curl -s "$api_url" | jq -r '.assets[] | select(.name=="framework.jar") | .browser_download_url')
          if [ -z "$asset_url" ] || [ "$asset_url" = "null" ]; then
            echo "‚ùå Kh√¥ng t√¨m th·∫•y asset framework.jar trong release tag ${SRC_TAG}"
            exit 1
          fi
          echo "‚úÖ Downloading: $asset_url"
          curl -L "$asset_url" -o framework_patcher/framework.jar
          ls -lh framework_patcher/

      - name: Make patch script executable
        run: chmod +x framework_patcher/patchframework.sh

      - name: Run patcher
        working-directory: framework_patcher
        run: |
          set -e
          # Ghi m·ªëc th·ªùi gian ƒë·ªÉ l·ªçc file m·ªõi sinh
          date -u +"%Y-%m-%dT%H:%M:%SZ" > ../_start_time
          ./patchframework.sh
          echo "==== AFTER PATCH ===="
          ls -lah

      - name: Collect outputs (flexible)
        run: |
          set -e
          START_TIME=$(cat _start_time)
          mkdir -p outputs

          # L·∫•y m·ªçi file t·∫°o/s·ª≠a sau khi patch (lo·∫°i tr·ª´ input & script)
          mapfile -t files < <(find framework_patcher -type f -newermt "$START_TIME" \
                                ! -name "framework.jar" \
                                ! -name "patchframework.sh" \
                                ! -name "*.log" \
                                ! -name "*.sh" 2>/dev/null)

          # Fallback n·∫øu mtime kh√¥ng kh·ªõp
          if [ ${#files[@]} -eq 0 ]; then
            echo "‚ö†Ô∏è  Fallback: qu√©t to√†n b·ªô th∆∞ m·ª•c."
            mapfile -t files < <(find framework_patcher -type f \
                                  ! -name "framework.jar" \
                                  ! -name "patchframework.sh" \
                                  ! -name "*.log" 2>/dev/null)
          fi

          if [ ${#files[@]} -eq 0 ]; then
            echo "‚ùå Kh√¥ng t√¨m th·∫•y file ƒë·∫ßu ra."
            find framework_patcher -maxdepth 2 -type f -printf "%TY-%Tm-%Td %TH:%TM:%TS %p\n" | sort
            exit 1
          fi

          echo "‚úÖ Files to publish:"
          printf '%s\n' "${files[@]}"

          cp -v "${files[@]}" outputs/
          ls -lah outputs

          # G√≥i th√™m 1 b·∫£n tar.gz cho ti·ªán t·∫£i 1 file
          tar -czf outputs-${{ env.OUT_TAG }}.tar.gz -C outputs .

      - name: Upload artifacts (download from this run)
        uses: actions/upload-artifact@v4
        with:
          name: patched-${{ env.OUT_TAG }}
          path: |
            outputs/
            outputs-${{ env.OUT_TAG }}.tar.gz
          if-no-files-found: error
          retention-days: 30

      - name: Print direct Artifact URL
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          run_id=${{ github.run_id }}
          repo=${{ github.repository }}
          # L·∫•y artifact id theo ƒë√∫ng t√™n
          resp=$(curl -s -H "Authorization: Bearer $GH_TOKEN" \
                 "https://api.github.com/repos/$repo/actions/runs/$run_id/artifacts")
          art_id=$(echo "$resp" | jq -r --arg NAME "patched-${OUT_TAG}" '.artifacts[] | select(.name==$NAME) | .id')
          if [ -n "$art_id" ] && [ "$art_id" != "null" ]; then
            echo ""
            echo "================ ARTIFACT DOWNLOAD LINK ================"
            echo "üëâ  https://github.com/$repo/actions/runs/$run_id/artifacts/$art_id"
            echo "========================================================"
            echo ""
          else
            echo "‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y artifact id ƒë·ªÉ in URL. V√†o tab Actions c·ªßa run n√†y ƒë·ªÉ t·∫£i."
          fi

      # (Tu·ª≥ ch·ªçn) Upload to√†n b·ªô th∆∞ m·ª•c ƒë·ªÉ debug
      - name: Upload full patcher folder (debug)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: debug-framework_patcher-${{ env.OUT_TAG }}
          path: framework_patcher/
