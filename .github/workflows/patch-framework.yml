name: Patch framework from Release → Create output Release

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag Release nguồn chứa framework.jar (ví dụ: v1)'
        required: true
        default: 'v1'

jobs:
  patch-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write   # cần để tạo release & upload asset
    env:
      SRC_TAG: ${{ github.event.inputs.tag }}
      REPO: ${{ github.repository }}
      OUT_TAG: pif-${{ github.event.inputs.tag }}-run-${{ github.run_number }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y openjdk-17-jre zip unzip jq curl

      - name: Download framework.jar from source Release
        run: |
          set -e
          mkdir -p framework_patcher
          api_url="https://api.github.com/repos/${REPO}/releases/tags/${SRC_TAG}"
          asset_url=$(curl -s "$api_url" | jq -r '.assets[] | select(.name=="framework.jar") | .browser_download_url')
          if [ -z "$asset_url" ] || [ "$asset_url" = "null" ]; then
            echo "❌ Không tìm thấy asset framework.jar trong release tag ${SRC_TAG}"
            exit 1
          fi
          echo "✅ Downloading: $asset_url"
          curl -L "$asset_url" -o framework_patcher/framework.jar
          ls -lh framework_patcher/

      - name: Make patch script executable
        run: chmod +x framework_patcher/patchframework.sh

      - name: Run patcher
        working-directory: framework_patcher
        run: |
          set -e
          # Ghi mốc thời gian trước khi patch để lọc file mới sinh ra
          date -u +"%Y-%m-%dT%H:%M:%SZ" > ../_start_time
          ./patchframework.sh
          echo "==== AFTER PATCH ===="
          ls -lah

      - name: Collect outputs (flexible)
        run: |
          set -e
          START_TIME=$(cat _start_time)
          mkdir -p outputs

          echo "Start time: $START_TIME"

          # Lấy mọi file tạo/sửa sau khi patch (loại trừ input & script)
          mapfile -t files < <(find framework_patcher -type f -newermt "$START_TIME" \
                                ! -name "framework.jar" \
                                ! -name "patchframework.sh" \
                                ! -name "*.log" \
                                ! -name "*.sh" 2>/dev/null)

          # Fallback nếu mtime không khớp
          if [ ${#files[@]} -eq 0 ]; then
            echo "⚠️  Không xác định được theo mốc thời gian, dùng fallback."
            mapfile -t files < <(find framework_patcher -type f \
                                  ! -name "framework.jar" \
                                  ! -name "patchframework.sh" \
                                  ! -name "*.log" 2>/dev/null)
          fi

          if [ ${#files[@]} -eq 0 ]; then
            echo "❌ Không tìm thấy file đầu ra. Danh sách file để debug:"
            find framework_patcher -maxdepth 2 -type f -printf "%TY-%Tm-%Td %TH:%TM:%TS %p\n" | sort
            exit 1
          fi

          echo "✅ Files to publish:"
          printf '%s\n' "${files[@]}"

          cp -v "${files[@]}" outputs/
          ls -lah outputs

          # Gói tiện dụng
          tar -czf outputs-${{ env.OUT_TAG }}.tar.gz -C outputs .

      - name: Upload artifacts (download/debug)
        uses: actions/upload-artifact@v4
        with:
          name: patched-${{ env.OUT_TAG }}
          path: |
            outputs/
            outputs-${{ env.OUT_TAG }}.tar.gz

      - name: Upload full patcher folder (debug)
        uses: actions/upload-artifact@v4
        with:
          name: debug-framework_patcher-${{ env.OUT_TAG }}
          path: framework_patcher/

      - name: Create output Release and upload assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.OUT_TAG }}
          name: Patched ${{ env.OUT_TAG }}
          body: |
            Auto-patched from source tag **${{ env.SRC_TAG }}**.
            This release is created by GitHub Actions.
          draft: false
          prerelease: false
          files: |
            outputs/*
            outputs-${{ env.OUT_TAG }}.tar.gz
